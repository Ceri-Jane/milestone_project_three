{% extends "base.html" %}
{% load static %}

{# Page-specific SEO overrides: custom title + meta tags #}

{% block title %}
<title>QuickFlicks | Home</title>
{% endblock %}

{% block meta_description %}
<meta name="description" content="Search for movies, view details and ratings, and add your favourites to personalised shelves on QuickFlicks.">
{% endblock %}

{% block meta_keywords %}
<meta name="keywords" content="movie search, film finder, tmdb search, movie results, quickflicks home">
{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<div class="hero-box" role="region" aria-labelledby="hero-title">

    <!-- ------------------------------------------------------------ -->
    <!-- LOGO (Optimised for Performance)                             -->
    <!-- WebP used for faster loading, with PNG fallback for safety.  -->
    <!-- Improves Lighthouse scores without changing visuals.         -->
    <!-- ------------------------------------------------------------ -->
    <picture>
        <source srcset="{% static 'images/logo.webp' %}" type="image/webp">
        <img src="{% static 'images/logo.png' %}" 
        alt="QuickFlicks Logo"
        class="hero-logo">
    </picture>
    
        <!-- Subtitle -->
    <p class="hero-subtitle" id="hero-title" aria-live="polite">
        Explore thousands of movies with their details and ratings.<br>
        Sign up <u>for free</u>, and Login to create your own shelves – keeping track of what you plan to watch and what you've already enjoyed.
    </p>

    {% if not user.is_authenticated %}
    <div class="hero-auth" role="group" aria-label="Authentication actions">
        <a href="{% url 'login' %}" 
           class="btn-outline"
           aria-label="Log into your QuickFlicks account">
            Login
        </a>
        <a href="{% url 'signup' %}" 
           class="btn-outline"
           aria-label="Create a new QuickFlicks account">
            Sign Up
        </a>
    </div>
    {% endif %}
</div>

<!-- SEARCH BAR -->
<form method="GET" 
      action="{% url 'home' %}" 
      class="search-form"
      role="search"
      aria-label="Search for movies">
    
    <input 
        type="text" 
        name="query" 
        placeholder="Search for a movie..."
        aria-label="Enter a movie title to search"
        value="{{ query }}">

    <button type="submit" aria-label="Search for movies">Search</button>
</form>

<!-- Divider -->
<div class="page-divider" role="separator"></div>

{% if movies %}
    <!-- Results heading -->
    <h1 class="results-heading" aria-live="polite">Results</h1>

    <div class="results-grid" role="list">

        {% for movie in movies %}
        <div class="movie-card" role="listitem">

            <!-- Poster -->
            <div class="poster-area">
                <img 
                    src="https://image.tmdb.org/t/p/w300{{ movie.poster_path|default:'' }}"
                    onerror="this.src='{% static 'images/movie-poster-unavailable.jpg' %}'"
                    alt="{{ movie.title }} movie poster"
                    aria-label="Poster for {{ movie.title }}">
            </div>

            <!-- Title -->
            <div class="movie-title" aria-label="Movie title: {{ movie.title }}">
                {{ movie.title }}
            </div>

            <!-- Rating + Release -->
            <div class="movie-meta">
                {% if movie.vote_average %}
                    <div class="movie-rating"
                         aria-label="Movie rating: {{ movie.vote_average }} out of 10">
                        ⭐ {{ movie.vote_average }}/10
                    </div>
                {% else %}
                    <div class="movie-rating" style="visibility:hidden;">⭐</div>
                {% endif %}

                <div class="movie-date"
                     aria-label="Release date: {{ movie.release_date|default:'Unknown' }}">
                    {{ movie.release_date|default:"Unknown" }}
                </div>
            </div>

            <!-- Overview -->
            <div class="movie-desc"
                 aria-label="Movie description">
                {{ movie.overview|default:"No description available." }}
            </div>

            <!-- ACTIONS -->
            <div class="card-actions" aria-label="Movie actions">

                {% if user.is_authenticated %}

                    {% if movie.id|stringformat:"s" in user_movie_ids %}
                        <!-- Already saved -->
                        <p class="in-shelf"
                           aria-label="This movie is already in your shelf">
                            ✅ Already in Your Shelf
                        </p>

                    {% else %}
                        <!-- Add Button -->
                        <form method="POST" action="{% url 'add_to_shelf' %}"
                              aria-label="Add {{ movie.title }} to your shelf">
                            {% csrf_token %}
                            <input type="hidden" name="tmdb_id" value="{{ movie.id }}">
                            <input type="hidden" name="title" value="{{ movie.title }}">
                            <input type="hidden" name="poster_path" value="{{ movie.poster_path }}">
                            <button class="btn-outline"
                                    aria-label="Add {{ movie.title }} to your shelf">
                                ➕ Add to My Shelf
                            </button>
                        </form>
                    {% endif %}

                {% else %}
                    <!-- Must login -->
                    <p class="login-msg"
                       aria-label="You need to log in to add movies to your shelf">
                        <a href="{% url 'login' %}">Log in</a> to add to your shelf.
                    </p>
                {% endif %}

            </div>

        </div>
        {% endfor %}

    </div>

{% elif query %}
    <p class="no-results"
       aria-live="assertive"
       aria-label="No movies found for your search term">
        No results found.
    </p>
{% endif %}

{% endblock %}
